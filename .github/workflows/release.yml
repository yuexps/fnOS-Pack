name: Build and Release

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * *' # 每天凌晨运行

jobs:
  build-and-release:
    name: Build Project and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check and Sync Version
        id: sync_ver
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 获取最新版本信息
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GH_TOKEN" https://api.github.com/repos/MCSManager/MCSManager/releases/latest)
          
          # 检查 API 访问是否受限
          if echo "$RELEASE_JSON" | jq -e '.message' > /dev/null; then
            echo "错误: GitHub API 访问受限: $(echo "$RELEASE_JSON" | jq -r .message)"
            exit 1
          fi

          LATEST_VER=$(echo "$RELEASE_JSON" | jq -r .tag_name | sed 's/^v//')
          LOCAL_VER=$(jq -r .version mcsmanager/app/server/web/package.json)
          echo "远程版本: $LATEST_VER, 本地版本: $LOCAL_VER"

          # 2. 如果版本落后则执行更新
          if [ "$LATEST_VER" != "$LOCAL_VER" ]; then
            echo "正在从 v$LOCAL_VER 更新到 v$LATEST_VER..."
            DOWNLOAD_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("linux_release")) | .browser_download_url')
            
            if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
              echo "错误: 未找到 linux_release 资源文件，无法更新"
              exit 1
            fi

            curl -L -o mcs.tar.gz "$DOWNLOAD_URL"
            mkdir -p temp && tar -xzf mcs.tar.gz -C temp
            
            # 安全地寻找目录并检查
            D_SRC=$(find temp -type d -name "daemon" | head -1)
            W_SRC=$(find temp -type d -name "web" | head -1)
            
            if [ -z "$D_SRC" ] || [ -z "$W_SRC" ]; then
              echo "错误: 压缩包内未找到 daemon 或 web 目录"
              exit 1
            fi

            # 替换代码
            rm -rf mcsmanager/app/server/daemon/* mcsmanager/app/server/web/*
            cp -r "$D_SRC"/* mcsmanager/app/server/daemon/
            cp -r "$W_SRC"/* mcsmanager/app/server/web/
            
            rm -rf temp mcs.tar.gz
            
            # Git 提交
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: auto-update to v$LATEST_VER [skip ci]"
            git push
            
            FINAL_VER=$LATEST_VER
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "当前已是最新版本"
            FINAL_VER=$LOCAL_VER
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

          # 3. 最终同步
          sed -i "s/version=.*/version=$FINAL_VER/" mcsmanager/manifest
          echo "FINAL_VER=$FINAL_VER" >> $GITHUB_ENV

      - name: Build Package
        if: steps.sync_ver.outputs.update_needed == 'true'
        run: |
          chmod +x ./build/fnpack-1.0.4-linux-amd64
          ./build/fnpack-1.0.4-linux-amd64 build mcsmanager

      - name: Create Release
        if: steps.sync_ver.outputs.update_needed == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          tag: v${{ env.FINAL_VER }}
          name: v${{ env.FINAL_VER }}
          allowUpdates: true
          body: |
            MCSManager 版本: ${{ env.FINAL_VER }}
            [更新日志](https://github.com/MCSManager/MCSManager/releases/tag/v${{ env.FINAL_VER }})
          artifacts: "mcsmanager.fpk"
          token: ${{ secrets.GITHUB_TOKEN }}
